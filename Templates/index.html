<!DOCTYPE html>
<html>

<head>
    <title>TensorView</title>
    <style>
        #table {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 30%;
        }

        #table td, #table th {
            border: 2px solid #ddd;
            padding: 6px;
        }

        #table tr:nth-child(even) {
            background-color: #F1F3FF;
        }

        #table tr:hover {
            background-color: #ddd;
        }

        .submit {
            background-color: #98fb98; /* Green */
            border: none;
            color: black;
            padding: 12px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            border-radius: 8px;
            -webkit-transition-duration: 0.4s; /* Safari */
            transition-duration: 0.4s;
            cursor: pointer;
        }

        .submit1 {
            background-color: white;
            color: black;
            border: 2px solid #98fb98;
        }

        .submit1:hover {
            background-color: #98fb98;
            color: white;
        }

        #go_button {
            background-color: #98fb98;
            font-size: 14px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="container">

    <h1>{{ table_name }}</h1>

    <button class="submit submit1" onclick="queryredirect()">Submit</button>
    <form class="Table_Body" id="table_body">

        <div id="table_rows">

            <table id="table">
                <tbody>
                {# building the headings of the table #}
                <tr>
                    {% for cell in headings %}
                        {%  if loop.index > 1  %}
                        <td><b id="heading_{{ loop.index -2 }}" value="{{ cell }}">{{ cell }}</b></td>
                        {% endif %}
                    {% endfor %}
                    <td><b>{{ "Graph?" }}</b></td>
                </tr>
                {# making the drop downs for the query selection#}
                <tr>
                    {% for cell in range((headings|length)) %}
                        {% if loop.index > 1 %}
                        <td><b>
                            <select id="drop_down_select_{{ cell }}">

                                {% if (table_contents|length) > 0 %}
                                    {% if table_contents[0][cell] is string %}
                                        <option value=" "></option>
                                        <option value="contains">Contains</option>
                                        <option value="startsWith">Starts with</option>
                                        <option value="endsWith">Ends with</option>
                                        <option value="exact">Exact</option>

                                    {% endif %}
                                    {% if table_contents[0][cell] is number %}
                                        <option value=" "></option>
                                        <option value="<"> <</option>
                                        <option value=">"> ></option>
                                        <option value="="> =</option>
                                        <option value=">="> >=</option>
                                        <option value="<="> <=</option>
                                    {% endif %}
                                {% endif %}

                            </select>
                            <INPUT TYPE="TEXT" NAME={{ cell }} SIZE="10" id='user_input_{{ cell }}'></b></td>

                        {% endif %}
                    {% endfor %}
                    <td>
                        <b>

                        </b></td>
                </tr>
                {#        filling in the table#}
                {% for  row in table_contents %}
                    <tr>
                        {% for cell in range((row|length)) %}
                            {% if loop.index > 1 %}
                            {% if table_contents[0][cell] is number %}

                                <td>{{ '%0.4f' % row[cell]|float }}</td>
                            {% else %}
                                <td>{{ row[cell] }}</td>
                            {% endif %}
                            {% endif %}
                        {% endfor %}
                        <td><label><input type="checkbox" value={{ run_names[row[0]] }}/> </label></td>
                    </tr>
                {% endfor %}
                <p>
                    <label>Regex: <input type="text" name="regex" value="()" readonly="readonly" id="regInput"/>
                    </label>
                    <button onclick="copyReg()">Copy Regex</button>
                </p>

                </tbody>
            </table>
        </div>
    </form>
</div>

</body>
<br>
<br>

</html>

<script>

    function attachCheckboxHandlers() {
        // get reference to element containing toppings checkboxes
        let el = document.getElementById('table_rows');

        // get reference to input elements in toppings container element
        let tops = el.getElementsByTagName('input');

        // assign updateTotal function to onclick property of each checkbox
        for (let i = 0, len = tops.length; i < len; i++) {
            if (tops[i].type === 'checkbox') {
                tops[i].onclick = updateRegex;
            }
        }
    }

    function updateRegex() {
        // 'this' is reference to checkbox clicked on
        let form = this.form;

        // get current value in total text box, using parseFloat since it is a string
        let currentRegex = form.elements['regex'].value;
        let namesWithPipes = currentRegex.substring(1, currentRegex.length - 1);
        if ("()" === currentRegex) {
            form.elements['regex'].value = "(" + this.value + ")";
            return;
        }

        var arr = namesWithPipes.split("|");
        // if check box is checked, add its value to val, otherwise subtract it
        if (this.checked) {
            arr.push(this.value);
        } else {
            let ind = arr.indexOf((this.value));
            if (ind !== -1) {
                arr.splice(ind, 1);
            }
        }

        form.elements['regex'].value = "(" + arr.join("|") + ")";
    }

    attachCheckboxHandlers();

    function copyReg() {
        let copyText = document.getElementById("regInput");
        copyText.select();
        document.execCommand("copy");
    }

    function queryredirect() {
        const sep_string = ">.<";
        var new_url = window.location.origin + "/runs/" + {{ eid }} +"/";

        var col_names = {{ col_names|safe }};
        let seen_hyper = false;
        let hyperQueries = [];
        let metricQueries = [];
        for (let i = 1; i <{{ number_of_cols }}; i++) {
            console.log(new_url);
            //selected comparator
            let dropdown = document.getElementById("drop_down_select_" + i);
            let comparator = dropdown.value;
            // input val
            let e = document.getElementById("user_input_" + i).value;

            // param compared against
            let col_name = col_names[i];
            if (comparator === " ") {
                continue;
            }

            if (i < {{ num_hyper_params }}-1) {
                hyperQueries.push(`${col_name}${sep_string}${comparator}${sep_string}${e}`);
            }  else if (i >= {{ num_hyper_params }}-1) {
                metricQueries.push(`${col_name}${sep_string}${comparator}${sep_string}${e}`)
            }

        }
        if (hyperQueries.length < 1){
              hyperQueries.push(`1${sep_string}=${sep_string}1`);
        }
        let hypers = hyperQueries.join('|');
        let metrics = metricQueries.join('|');


        console.log(hypers);
        console.log(metrics);
        new_url = `${new_url}${hypers}/${metrics}`;
        if (window.href != new_url) {
            window.location.replace(new_url);
        }

    }

</script>

{#code for syling used from here#}
{#https://www.w3schools.com/css/tryit.asp?filename=trycss_table_fancy#}


{#https://stackoverflow.com/questions/32516455/how-to-create-url-according-to-the-checked-checkboxes#}
{#https://stackoverflow.com/questions/22505825/creating-string-of-checkbox-ids-if-checked#}
{#https://coderwall.com/p/pkthoa/read-checkbox-in-flask#}
{#https://gist.github.com/devdave/1472832#}
{#https://www.dyn-web.com/tutorials/forms/checkbox/group.php#}